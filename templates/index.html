<!DOCTYPE html>
<html>
<head>
    <title>Web Chess</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

<h2>Chess Game</h2>
<div id="board"></div>
<script>
let selected = null;     // { r, c }
let legalMoves = [];
let turn = null;        // backend controlled

const pieceMap = {
    "P": "â™™", "R": "â™–", "N": "â™˜", "B": "â™—", "Q": "â™•", "K": "â™”",
    "p": "â™Ÿ", "r": "â™œ", "n": "â™ž", "b": "â™", "q": "â™›", "k": "â™š",
    ".": ""
};

/* =========================
   LOAD GAME STATE
   ========================= */
async function loadState() {
    const stateRes = await fetch("/state");
    const stateData = await stateRes.json();
    turn = stateData.turn;
    renderBoard(stateData.board);
}

/* =========================
   HANDLE CLICK
   ========================= */
async function handleClick(r, c) {
    // always sync with backend
    const stateRes = await fetch("/state");
    const stateData = await stateRes.json();
    const board = stateData.board;
    turn = stateData.turn;

    const piece = board[r][c];

    /* ---- SELECT PIECE ---- */
    if (!selected) {
        if (
            piece === "." ||
            (turn === "white" && piece === piece.toLowerCase()) ||
            (turn === "black" && piece === piece.toUpperCase())
        ) {
            return;
        }
        
        selected = { r, c };

        const movesRes = await fetch("/legal-moves", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ r, c })
        });

        legalMoves = await movesRes.json();
        renderBoard(board);
        return;
    }

    /* ---- TRY MOVE ---- */
    const from = { ...selected };
    const isLegal = legalMoves.some(m => m.r === r && m.c === c);

    // clear selection
    selected = null;
    legalMoves = [];
    renderBoard(board);

    if (!isLegal) return;

    const moveRes = await fetch("/move", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            r1: from.r,
            c1: from.c,
            r2: r,
            c2: c
        })
    });

    if (moveRes.ok) {
        const moveData = await moveRes.json();
        turn = moveData.turn;
        renderBoard(moveData.board);
    } else {
        alert("Illegal move");
    }
}

/* =========================
   RENDER BOARD
   ========================= */
function renderBoard(board) {
    const boardDiv = document.getElementById("board");
    boardDiv.innerHTML = "";

    for (let r = 0; r < 8; r++) {
        for (let c = 0; c < 8; c++) {
            const square = document.createElement("div");
            square.className = "square";

            square.style.backgroundColor =
                (r + c) % 2 === 0 ? "#fbe1a4bb" : "#b58863";

            // ðŸ”´ selected square
            if (selected && selected.r === r && selected.c === c) {
                square.classList.add("selected");
            }

            // ðŸŸ¢ legal move square  â† THIS MUST EXIST
            if (legalMoves.some(m => m.r === r && m.c === c)) {
                square.classList.add("legal");
            }     
                   
            square.textContent = pieceMap[board[r][c]];
            square.onclick = () => handleClick(r, c);
            boardDiv.appendChild(square);
        }
    }
}

/* =========================
   START APP
   ========================= */
loadState();
</script>

</body>
</html>