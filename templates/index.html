<!DOCTYPE html>
<html>
<head>
    <title>Web Chess</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

<h2>Chess Game</h2>
<button id="reset-btn">Reset Game</button>

<div id="container">
    <div id="board"></div>

    <div id="history-panel">
        <h3>Move History</h3>
        <ol id="move-list"></ol>
    </div>
</div>

<script>
    
let selected = null;     // { r, c }
let legalMoves = [];
let turn = null;        // backend controlled
let checkStatus = "ok";
let gameOver = false;

const pieceMap = {
    "P": "â™™", "R": "â™–", "N": "â™˜", "B": "â™—", "Q": "â™•", "K": "â™”",
    "p": "â™Ÿ", "r": "â™œ", "n": "â™ž", "b": "â™", "q": "â™›", "k": "â™š",
    ".": ""
};

function updateHistory(history) {
    const list = document.getElementById("move-list");
    const panel = document.getElementById("history-panel");

    list.innerHTML = "";

    history.forEach(move => {
        const li = document.createElement("li");
        li.textContent = move;
        list.appendChild(li);
    });

    panel.scrollTop = panel.scrollHeight;
}

document.getElementById("reset-btn").onclick = async () => {
    const res = await fetch("/reset", { method: "POST" });
    const data = await res.json();

    selected = null;
    legalMoves = [];
    checkStatus = "ok";
    gameOver = false;
    turn = data.turn;

    renderBoard(data.board);
    updateHistory([]);
};

async function loadState() {
    const stateRes = await fetch("/state");
    const stateData = await stateRes.json();
    turn = stateData.turn;
    renderBoard(stateData.board);
}

async function handleClick(r, c) {
    if (gameOver) return;
    // always sync with backend
    const stateRes = await fetch("/state");
    const stateData = await stateRes.json();
    const board = stateData.board;
    turn = stateData.turn;

    const piece = board[r][c];

    /* ---- SELECT PIECE ---- */
    if (!selected) {
        if (
            piece === "." ||
            (turn === "white" && piece === piece.toLowerCase()) ||
            (turn === "black" && piece === piece.toUpperCase())
        ) {
            return;
        }

        selected = { r, c };

        const movesRes = await fetch("/legal-moves", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ r, c })
        });

        legalMoves = await movesRes.json();
        renderBoard(board);
        return;
    }

    /* ---- TRY MOVE ---- */
    const from = { ...selected };
    const isLegal = legalMoves.some(m => m.r === r && m.c === c);

    // clear selection
    selected = null;
    legalMoves = [];
    renderBoard(board);

    if (!isLegal) return;

    const moveRes = await fetch("/move", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            r1: from.r,
            c1: from.c,
            r2: r,
            c2: c
        })
    });

    if (moveRes.ok) {
        const moveData = await moveRes.json();
        turn = moveData.turn;
        checkStatus = moveData.status;
        renderBoard(moveData.board);

        updateHistory(moveData.history);

        if (checkStatus === "checkmate") {
            gameOver = true;

            const winner = turn === "white" ? "Black" : "White";
            window.location.href =
                `/game-over?result=checkmate&winner=${winner}`;
        }

        if (checkStatus === "stalemate") {
            gameOver = true;
            window.location.href = `/game-over?result=stalemate`;
        }


    } else {
        alert("Illegal move");
    }
}

function renderBoard(board) {
    const boardDiv = document.getElementById("board");
    boardDiv.innerHTML = "";

    let kingInCheck = null;
    if (checkStatus === "check_white") {
        kingInCheck = getKingPosition(board, "white");
    } else if (checkStatus === "check_black") {
        kingInCheck = getKingPosition(board, "black");
    }


    for (let r = 0; r < 8; r++) {
        for (let c = 0; c < 8; c++) {
            const square = document.createElement("div");
            square.className = "square";

            square.style.backgroundColor =
                (r + c) % 2 === 0 ? "#fbe1a4bb" : "#b58863";

            // ðŸ”´ selected square
            if (selected && selected.r === r && selected.c === c) {
                square.classList.add("selected");
            }

            // ðŸŸ¢ legal move square  â† THIS MUST EXIST
            if (legalMoves.some(m => m.r === r && m.c === c)) {
                square.classList.add("legal");
            }     
            
            // ðŸ”´ king in check
            if (
                kingInCheck &&
                kingInCheck.r === r &&
                kingInCheck.c === c
            ) {
                square.classList.add("check");
            }

            square.textContent = pieceMap[board[r][c]];
            square.onclick = () => handleClick(r, c);
            boardDiv.appendChild(square);
        }
    }
}

function getKingPosition(board, color) {
    const kingChar = color === "white" ? "K" : "k";

    for (let r = 0; r < 8; r++) {
        for (let c = 0; c < 8; c++) {
            if (board[r][c] === kingChar) {
                return { r, c };
            }
        }
    }
    return null;
}

loadState();
</script>

</body>
</html>